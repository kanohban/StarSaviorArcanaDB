<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>스타 세이비어 DB - 여정</title>
    <link rel="icon" type="image/png" href="./images/index/index_icon.png">
    <link rel="stylesheet" crossorigin href="./assets/index-DBwFzK5i.css">
    <link rel="stylesheet" href="./assets/header.css">
    <!-- Import Search CSS for Card Styling -->
    <link rel="stylesheet" href="./assets/search.css">
    <style>
        /* Base styles from journey.html */
        :root {
            --result-bg: #f9f9f9;
        }

        [data-theme="dark"] {
            --result-bg: #2c2c2c;
        }

        .journey-container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            transition: max-width 0.3s ease;
        }

        .app-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: var(--header-bg);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
            padding: 0;
            gap: 0.5rem;
        }

        .header-bottom {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding-bottom: 10px;
        }

        /* Revised Search Container to include filters */
        .search-area-wrapper {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .search-input-wrapper {
            width: 100%;
            max-width: 400px;
            /* Reduced from 600px */
            padding: 0 10px;
            box-sizing: border-box;
            margin: 0 auto;
            display: flex;
            justify-content: center;
        }

        /* Re-use .search-input from index-DBwFzK5i.css, but ensure width is correct */
        .search-input {
            width: 100%;
            max-width: 100% !important;
            text-align: left;
            padding: 8px 12px;
            /* Reduced padding if it was larger */
            font-size: 0.95rem;
            /* Slightly smaller font */
            height: 40px;
            /* Fixed height for consistency */
        }

        /* Filter Checkboxes next to search bar (or below) */
        .search-filters-inline {
            display: flex;
            gap: 15px;
            margin-bottom: 5px;
        }

        .filter-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
            cursor: pointer;
            user-select: none;
        }

        /* Tab Nav */
        .tab-nav {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .tab-nav.disabled {
            opacity: 0.5;
            pointer-events: none;
            filter: grayscale(100%);
            /* Hide tabs when searching to focus on results? Or just disable? */
            display: none;
        }

        .tab-btn {
            padding: 8px 16px;
            background: var(--card-bg);
            border: 1px solid var(--primary-color);
            color: var(--text-color);
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            background: rgba(var(--primary-color-rgb), 0.1);
        }

        .tab-btn.active {
            background: var(--primary-color) !important;
            color: #fff !important;
            border-color: var(--primary-color) !important;
            opacity: 1 !important;
        }

        /* Event Card Styles (Journey) */
        .event-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .event-name {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .event-meta-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }

        .meta-row {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 6px;
        }

        .meta-pill {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: 1px solid transparent;
            white-space: nowrap;
        }

        .meta-pill.value-timing {
            background-color: #ffffff;
            color: #1565c0;
            border: 1px solid #bbdefb;
        }

        [data-theme="dark"] .meta-pill.value-timing {
            background-color: #2c2c2c;
            color: #90caf9;
            border-color: #1565c0;
        }

        .meta-pill.value-condition {
            background-color: #ffffff;
            color: #e57373;
            border: 1px solid #e57373;
        }

        [data-theme="dark"] .meta-pill.value-condition {
            background-color: #2c2c2c;
            color: #ef9a9a;
            border-color: #ef9a9a;
        }

        .choice-list {
            list-style: none;
            padding: 0;
            margin: 10px 0 0 0;
        }

        .choice-item {
            padding: 5px 0;
            margin-bottom: 8px;
        }

        .choice-text {
            font-weight: bold;
            display: block;
            margin-bottom: 0;
        }

        .choice-results {
            margin-top: 5px;
            padding: 10px;
            background-color: var(--result-bg);
            border-radius: 8px;
            border: 1px solid var(--input-border);
        }

        .result-positive {
            color: #4caf50;
            margin-bottom: 2px;
            white-space: pre-wrap;
        }

        .result-negative {
            color: #ff5252;
            margin-bottom: 2px;
            white-space: pre-wrap;
        }

        .result-common {
            color: var(--text-color);
            white-space: pre-wrap;
        }

        .result-label {
            font-weight: bold;
            margin-right: 5px;
            opacity: 0.8;
        }

        /* Integrated Search Results Grid */
        #search-results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        /* .result-card-container.type-journey {
            grid-column: 1 / -1; 
        } */

        /* Mobile Mode Styles */
        body.mobile-mode .journey-container {
            max-width: 480px;
        }

        @media (max-width: 768px) {
            .tab-nav {
                gap: 6px;
                flex-wrap: nowrap;
                justify-content: flex-start;
                padding: 0 10px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .tab-nav::-webkit-scrollbar {
                display: none;
            }

            .tab-btn {
                padding: 6px 10px;
                font-size: 0.9rem;
                flex-shrink: 0;
            }
        }
    </style>
</head>

<body>
    <div class="app">
        <header class="app-header">
            <!-- Header content injected by HeaderManager -->
            <div class="header-bottom">

                <div class="search-area-wrapper">
                    <div class="search-input-wrapper">
                        <input type="text" id="journey-search" class="search-input"
                            placeholder="통합 검색 (카드, 이벤트, 보상 등)..." autocomplete="off">
                    </div>
                    <div class="search-filters-inline">
                        <label class="filter-checkbox">
                            <input type="checkbox" id="filter-card" checked> <span>아르카나</span>
                        </label>
                        <label class="filter-checkbox">
                            <input type="checkbox" id="filter-journey" checked> <span>여정 이벤트</span>
                        </label>
                    </div>
                </div>

                <div class="tab-nav">
                    <button class="tab-btn active" data-tab="journey" onclick="switchTab('journey')">여정</button>
                    <button class="tab-btn" data-tab="resette" onclick="switchTab('resette')">리세트</button>
                    <button class="tab-btn" data-tab="subjugation" onclick="switchTab('subjugation')">토벌</button>
                    <button class="tab-btn" data-tab="aganon" onclick="switchTab('aganon')">아가논</button>
                    <button class="tab-btn" data-tab="flora" onclick="switchTab('flora')">플로라</button>
                    <button class="tab-btn" data-tab="kalide" onclick="switchTab('kalide')">칼라이드</button>
                    <button class="tab-btn" data-tab="weather" onclick="switchTab('weather')">날씨</button>
                </div>
            </div>
        </header>

        <div class="journey-container">
            <div id="content-area">
                <div style="text-align: center; padding: 20px;">Loading...</div>
            </div>
            <!-- Separate Container for Search Results to use grid layout if needed -->
            <div id="search-results-grid" style="display: none;"></div>
        </div>

        <!-- Modal Structure (for Cards) -->
        <div id="card-modal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <button class="modal-close">&times;</button>
                <div class="modal-content-body">
                    <!-- Dynamic Content -->
                </div>
            </div>
        </div>

        <footer id="footer-container"></footer>
    </div>

    <!-- Scripts -->
    <script src="./assets/header_manager.js?v=6.0.0"></script>
    <script src="./assets/footer_manager.js"></script>
    <script src="./assets/hangul_utils.js?v=6.0.0"></script>
    <!-- Import Search Service -->
    <script src="./assets/search_service.js?v=6.0.0"></script>

    <script>
        let allData = {}; // Original Journey Data (grouped)
        let currentTab = 'journey';
        let potentialsData = {};

        // 1. Initialize Header/Footer
        document.addEventListener('DOMContentLoaded', () => {
            const appHeader = document.querySelector('.app-header');
            const wrapper = document.createElement('div');
            wrapper.className = 'custom-header-wrapper';
            appHeader.insertBefore(wrapper, appHeader.firstChild);

            if (window.HeaderManager) window.HeaderManager.init(wrapper, 'journey');
            if (window.FooterManager) window.FooterManager.init(document.getElementById('footer-container'));

            // Theme Init
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            if (localStorage.getItem('viewMode') === 'mobile') document.body.classList.add('mobile-mode');

            loadData();
            initModal();
        });

        // 2. Load Data (Journey + Cards for SearchService)
        async function loadData() {
            try {
                const [cardsRes, journeyRes, potentialsRes] = await Promise.all([
                    fetch('./data/cards.json'),
                    fetch('./data/journey_data.json'),
                    fetch('./data/potentials.json')
                ]);

                if (!journeyRes.ok) throw new Error("Failed to load journey data");

                allData = await journeyRes.json(); // Journey Data Structure kept for Tabs
                const cardsData = await cardsRes.json();
                potentialsData = await potentialsRes.json();

                // Build Search Index
                window.SearchService.buildIndex(cardsData, allData, potentialsData);

                console.log('Data loaded & Index built');
                render(); // Initial Tab Render
            } catch (error) {
                console.error('Failed to load data:', error);
                document.getElementById('content-area').innerHTML = `<div style="text-align:center;color:red;">데이터 로드 실패: ${error.message}</div>`;
            }
        }

        // 3. Tab Logic
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });
            render();
        }

        function render() {
            const container = document.getElementById('content-area');
            const searchGrid = document.getElementById('search-results-grid');

            // Ensure Search Grid is hidden, Content is shown
            searchGrid.style.display = 'none';
            container.style.display = 'block';

            const data = allData[currentTab] || [];
            if (data.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:20px;">데이터가 없습니다.</div>';
                return;
            }
            renderEvents(data, `총 ${data.length}개의 이벤트가 있습니다.`);
        }

        // Original Journey Render Helper
        function renderEvents(data, message) {
            const container = document.getElementById('content-area');
            let html = `<div style="text-align:center; margin-bottom:10px; color:#aaa;">${message}</div>`;

            data.forEach(event => {
                html += generateEventCardHTML(event);
            });
            container.innerHTML = html;
        }

        function generateEventCardHTML(event) {
            const timings = event.timing ? event.timing.split(',').map(t => t.trim()).filter(t => t) : [];
            const conditions = event.condition ? event.condition.split(',').map(c => c.trim()).filter(c => c) : [];

            return `
                <div class="event-card">
                    <div class="event-name">${event.name}</div>
                    
                    <div class="event-meta-container">
                        ${timings.length > 0 ? `<div class="meta-row">${timings.map(t => `<span class="meta-pill value-timing">${t}</span>`).join('')}</div>` : ''}
                        ${conditions.length > 0 ? `<div class="meta-row">${conditions.map(c => `<span class="meta-pill value-condition">${c}</span>`).join('')}</div>` : ''}
                    </div>

                    <ul class="choice-list">
                        ${event.choices.map(choice => `
                            <li class="choice-item">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px;">
                                    <span class="choice-text" style="margin-bottom: 0;">${choice.text}</span>
                                    ${choice.condition ? `<span class="meta-pill value-condition" style="font-size:0.8rem; padding:2px 10px; margin-left: 10px; flex-shrink: 0;">${choice.condition}</span>` : ''}
                                </div>
                                <div class="choice-results">
                                    ${choice.result_positive ? `<div class="result-positive"><span class="result-label">성공:</span> ${choice.result_positive}</div>` : ''}
                                    ${choice.result_negative ? `<div class="result-negative"><span class="result-label">실패:</span> ${choice.result_negative}</div>` : ''}
                                    ${choice.result ? `<div class="result-common">${choice.result}</div>` : ''}
                                </div>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
        }

        // 4. Search Logic Upgrade
        const searchInput = document.getElementById('journey-search');
        const tabNav = document.querySelector('.tab-nav');
        const contentArea = document.getElementById('content-area');
        const searchResultsGrid = document.getElementById('search-results-grid');
        const filterCard = document.getElementById('filter-card');
        const filterJourney = document.getElementById('filter-journey');

        // Debounce using SearchService utility
        const debouncedSearch = (window.SearchService && window.SearchService.debounce) ? window.SearchService.debounce((query) => {
            performSearch(query);
        }, 300) : (query) => performSearch(query); // Fallback if not ready

        searchInput.addEventListener('input', (e) => debouncedSearch(e.target.value));
        filterCard.addEventListener('change', () => performSearch(searchInput.value));
        filterJourney.addEventListener('change', () => performSearch(searchInput.value));

        function performSearch(query) {
            query = query.trim();

            if (!query) {
                // Restore Tab View
                tabNav.classList.remove('disabled');
                tabNav.style.display = 'flex';
                contentArea.style.display = 'block';
                searchResultsGrid.style.display = 'none';
                render();
                return;
            }

            // Active Search
            tabNav.classList.add('disabled');
            tabNav.style.display = 'none'; // Hide tabs to give space
            contentArea.style.display = 'none';
            searchResultsGrid.style.display = 'grid'; // Grid mode for Cards

            const results = window.SearchService.search(query, {
                showCards: filterCard.checked,
                showJourneys: filterJourney.checked
            });

            renderSearchResults(results, query);
        }

        function renderSearchResults(results, query) {
            searchResultsGrid.innerHTML = '';

            if (results.length === 0) {
                searchResultsGrid.innerHTML = '<div style="grid-column: 1/-1; text-align:center; padding:20px;">검색 결과가 없습니다.</div>';
                return;
            }

            const fragment = document.createDocumentFragment();

            results.forEach(item => {
                const wrapper = document.createElement('div');
                // Remove type-${item.type} from wrapper to prevent double-border (as type-class adds border in search.css)
                wrapper.className = 'result-card-container';

                // Unified Generic Card for Grid
                const badgeText = item.type === 'card' ? '아르카나' : '여정 이벤트';

                // Unified styling: "result-card" class provides base, inline style ensures consistency
                // Note: We use .result-card for both to ensure they look same (rounded box).
                wrapper.innerHTML = `
                    <div class="result-card type-${item.type}" style="height: auto; min-height: 100%; border-radius:12px; box-sizing:border-box;">
                        <div class="result-type-badge type-${item.type}">${badgeText}</div>
                        <div class="result-title">${highlightText(item.title, query)}</div>
                        <div class="result-subtitle">${item.subtitle}</div>
                        <div class="result-content">${highlightText(item.content, query)}</div>
                    </div>
                `;

                // Click opens modal
                wrapper.querySelector('.result-card').addEventListener('click', () => {
                    openModal(item);
                });

                fragment.appendChild(wrapper);
            });

            searchResultsGrid.appendChild(fragment);
        }

        function highlightText(text, query) {
            if (!query || !text) return text;
            try {
                const escapedQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp(escapedQuery, 'gi');
                return text.replace(regex, '<span class="highlight">$&</span>');
            } catch (e) {
                return text;
            }
        }

        // 5. Modal Logic
        const modal = document.getElementById('card-modal');
        const modalClose = document.querySelector('.modal-close');
        const modalContent = document.querySelector('.modal-content-body');

        function initModal() {
            if (modalClose) modalClose.addEventListener('click', closeModal);
            window.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });
        }

        function closeModal() {
            if (modal) modal.style.display = 'none';
        }

        // Renamed from openCardModal to openModal to handle both types
        function openModal(item) {
            if (!modal) return;
            let html = '';

            // item might be the search result object { type, data, ... }
            if (item.type === 'journey') {
                const eventData = item.data;
                // Header for Journey Modal
                html += `<div style="padding-bottom:10px; border-bottom:1px solid #444; margin-bottom:15px;">
                            <h2 style="margin:0; color:var(--primary-color);">${eventData.name} <small style='color:#aaa; font-size:0.6em;'>[${eventData.category}]</small></h2>
                         </div>`;
                html += generateEventCardHTML(eventData);

            } else {
                // Card Logic
                // If item is 'card' type, item.data is the card object.
                const card = item.data || item;

                let typeStr = '';
                if (card.타입) {
                    if (card.레어도 === 'SSR') {
                        typeStr = `${card.타입.훈련 || ''} / ${card.타입.보조1 || ''} / ${card.타입.보조2 || ''}`;
                    } else {
                        typeStr = card.타입.훈련 || '';
                    }
                }

                let potentialDesc = '-';
                if (card.고유잠재 && card.고유잠재.이름 && potentialsData) {
                    potentialDesc = potentialsData[card.고유잠재.이름] || '-';
                }

                html = `
                    <div class="modal-card-header">
                        <img src="${card.이미지}" alt="${card.이름}" class="modal-card-img" onerror="this.style.display='none'">
                        <div class="modal-card-info">
                            <h2>${card.이름}</h2>
                            <div class="modal-card-meta">
                                <span class="badge badge-rarity">${card.레어도}</span>
                                <span class="badge badge-type">${typeStr}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-section">
                        <h3>고유 효과: ${card.고유효과?.이름 || '-'}</h3>
                        <p>${card.고유효과?.설명 || '-'}</p>
                    </div>

                    <div class="modal-section">
                        <h3>고유 잠재: ${card.고유잠재?.이름 || '-'}</h3>
                        <p>${potentialDesc}</p>
                    </div>
                `;

                // --- Events Section (Full Render) ---
                if (card.이벤트) {
                    html += `<div class="modal-section"><h3>여정 이벤트</h3>`;

                    ['1단계', '2단계', '3단계'].forEach((stageKey, index) => {
                        const stage = card.이벤트[stageKey];
                        if (stage) {
                            const eventName = (card.이벤트.이름 && card.이벤트.이름[index]) ? card.이벤트.이름[index] : stageKey;
                            html += `
                                <div class="stage-block">
                                    <h4>${eventName}</h4>
                                    <div class="stage-choices">
                            `;

                            const hasB = stage['선택지B'] && stage['선택지B'].length > 0 && stage['선택지B'][0].획득 && stage['선택지B'][0].획득.length > 0;

                            ['선택지A', '선택지B'].forEach(choiceKey => {
                                const choiceName = stage.이름_선택지?.[choiceKey] || (choiceKey === '선택지A' ? 'A' : 'B');
                                const choices = stage[choiceKey];

                                if (choices && choices.length > 0 && choices[0].획득 && choices[0].획득.length > 0) {
                                    html += `<div class="choice-column">`;

                                    if (choiceKey === '선택지B' || hasB) {
                                        html += `<div class="choice-header">${choiceName}</div>`;
                                    }

                                    html += `<div class="choice-rewards">`;

                                    choices.forEach(group => {
                                        if (group.획득 && group.획득.length > 0) {
                                            html += `<div class="reward-group ${group.여부 === '성공' ? 'success' : (group.여부 === '실패' ? 'fail' : '')}">`;
                                            if (group.여부 !== '고정') html += `<div class="reward-badge">${group.여부}</div>`;

                                            group.획득.forEach(item => {
                                                html += `<div class="reward-item">
                                                    <span class="reward-type">${item.타입}</span>
                                                    <span class="reward-value">${item.수치}</span>
                                                </div>`;
                                            });
                                            html += `</div>`;
                                        }
                                    });

                                    html += `</div></div>`;
                                }
                            });

                            html += `</div></div>`;
                        }
                    });

                    html += `</div>`;
                }
            }

            modalContent.innerHTML = html;
            modal.style.display = 'flex';
        }

    </script>
</body>

</html>