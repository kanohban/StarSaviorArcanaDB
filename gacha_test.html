<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>스타 세이비어 DB - 가챠 (TEST)</title>
    <link rel="icon" type="image/png" href="./images/index/index_icon.png">
    <!-- Using the TEST CSS file -->
    <link rel="stylesheet" crossorigin href="./assets/index-DBwFzK5i.css">
    <link rel="stylesheet" href="./assets/header.css?v=6.0.0">
    <link rel="stylesheet" href="./assets/gacha_test.css?v=6.1.1">

</head>

<body>
    <div class="app">
        <header id="header-container"></header>

        <main class="gacha-container">
            <div class="banner-section">
                <!-- Tabs for Banners -->
                <div class="banner-tabs">
                    <button class="banner-tab active" data-banner="구원자-통상">구원자-통상</button>
                    <button class="banner-tab" data-banner="구원자-픽업">구원자-픽업</button>
                    <button class="banner-tab" data-banner="아르카나-통상">아르카나-통상</button>
                    <button class="banner-tab" data-banner="아르카나-픽업">아르카나-픽업</button>
                </div>
            </div>

            <div class="control-section">
                <button class="gacha-btn btn-single" onclick="pullGacha(1)">1회 소환</button>
                <button class="gacha-btn btn-multi" onclick="pullGacha(10)">10회 소환</button>
            </div>

            <div id="result-area" class="result-grid">
                <p class="placeholder-text">원하는 소환을 선택하세요</p>
            </div>

            <!-- Stats Section -->
            <div class="stats-section">
                <div class="stats-info">
                    <div class="stat-item">
                        <span class="stat-label">총 소환</span>
                        <span id="stat-total" class="stat-value">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">SSR 획득</span>
                        <span id="stat-ssr" class="stat-value ssr">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">SSR 확률</span>
                        <span id="stat-ratio" class="stat-value">0.00%</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">픽업 획득</span>
                        <span id="stat-pickup" class="stat-value pickup">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">픽업 확률</span>
                        <span id="stat-pickup-ratio" class="stat-value">0.00%</span>
                    </div>
                </div>
                <button class="btn-reset" onclick="resetStats()">통계 초기화</button>
            </div>
        </main>

        <footer id="footer-container"></footer>
    </div>

    <!-- Scripts -->
    <script src="./assets/header_manager.js?v=6.0.0"></script>
    <script src="./assets/footer_manager.js"></script>
    <!-- REMOVED gacha_manager.js and replaced with INLINE script for testing -->
    <script>
        // MOCK DATA FOR TESTING
        const gachaData = {
            "구원자-통상": [
                { "등급": "SSR", "이름": "레이시", "확률": 0.05 },
                { "등급": "SSR", "이름": "루나", "확률": 0.05 },
                { "등급": "SR", "이름": "베라", "확률": 0.2 },
                { "등급": "SR", "이름": "안나", "확률": 0.2 },
                { "등급": "R", "이름": "아르카나", "확률": 0.5 }
            ],
            "구원자-픽업": [
                { "등급": "SSR", "이름": "픽업", "확률": 0.05 },
                { "등급": "R", "이름": "아르카나", "확률": 0.95 }
            ],
            "아르카나-통상": [
                { "등급": "SSR", "이름": "만족스러운 식사", "확률": 0.1 },
                { "등급": "R", "이름": "아르카나", "확률": 0.9 }
            ],
            "아르카나-픽업": [
                { "등급": "SSR", "이름": "픽업", "확률": 0.1 },
                { "등급": "R", "이름": "아르카나", "확률": 0.9 }
            ]
        };

        const allCards = [
            { "등급": "R", "이름": "기본 아르카나" }
        ];

        let currentBanner = '구원자-통상';
        let totalPulls = 0;
        let ssrCount = 0;
        let pickupCount = 0;

        // Init
        (function () {
            const html = document.documentElement;
            const savedTheme = localStorage.getItem('theme') || 'dark';
            html.setAttribute('data-theme', savedTheme);

            // Bind Tabs
            document.querySelectorAll('.banner-tab').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.banner-tab').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentBanner = btn.dataset.banner;
                });
            });
        })();

        document.addEventListener('DOMContentLoaded', () => {
            if (window.HeaderManager) window.HeaderManager.init(document.getElementById('header-container'), 'gacha');
            if (window.FooterManager) window.FooterManager.init(document.getElementById('footer-container'));
        });

        function pullGacha(count) {
            const pool = gachaData[currentBanner];
            const results = [];

            for (let i = 0; i < count; i++) {
                results.push(drawOne(pool));
            }

            renderResults(results);
            updateStats(results);
        }

        function drawOne(pool) {
            const rand = Math.random();
            let cumulative = 0;
            for (const item of pool) {
                cumulative += item.확률;
                if (rand < cumulative) {
                    // If it is generic Arcana, make it look like one
                    if (item.이름 === '아르카나') {
                        return { ...item, 이름: '아르카나 예시' + Math.floor(Math.random() * 10) };
                    }
                    return { ...item };
                }
            }
            return { ...pool[0] };
        }

        function renderResults(results) {
            const grid = document.getElementById('result-area');
            grid.innerHTML = '';

            results.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = `gacha-card rarity-${item.등급}`;
                card.style.animationDelay = `${index * 100}ms`;

                // Mock Images
                // We will use a placeholder or try to load real images if they exist
                // But for layout check, the card container size matters most.

                let imgPath = `./images/illust/${item.이름}.webp`;
                let isArcana = false;

                if (item.이름.startsWith('아르카나')) {
                    imgPath = './images/cards/아르카나.png'; // Fallback
                    isArcana = true;
                }

                if (isArcana) card.classList.add('is-arcana');

                card.innerHTML = `
                      <div class="gacha-fallback-text">${item.이름}</div>
                      <img src="${imgPath}" class="gacha-card-img" onerror="this.style.display='none'">
                      <div class="gacha-card-name">${item.이름}</div>
                 `;

                grid.appendChild(card);
            });
        }

        function updateStats(results) {
            totalPulls += results.length;
            const newSSRs = results.filter(item => item.등급 === 'SSR');
            ssrCount += newSSRs.length;

            document.getElementById('stat-total').textContent = totalPulls;
            document.getElementById('stat-ssr').textContent = ssrCount;

            const ratio = totalPulls > 0 ? (ssrCount / totalPulls) * 100 : 0;
            document.getElementById('stat-ratio').textContent = ratio.toFixed(2) + '%';
        }

        function resetStats() {
            totalPulls = 0;
            ssrCount = 0;
            document.getElementById('stat-total').textContent = 0;
            document.getElementById('stat-ssr').textContent = 0;
            document.getElementById('stat-ratio').textContent = "0.00%";
        }
    </script>
</body>

</html>